import { uploadsDir } from '../server.ts'
import type { FastifyRequest, FastifyReply } from 'fastify';
import { pipeline } from 'stream/promises';
import { createWriteStream } from 'fs';
import path from 'path';

export const uploadFile = async (request: FastifyRequest, reply: FastifyReply) => {

	const data = await request.file();
	if (!data) {

		return reply.code(400).send({ error: 'No file uploaded' });

	}


	const filename = data.filename;

	const filepath = path.join(uploadsDir, filename);


	try {

		await pipeline(data.file, createWriteStream(filepath));


		return {

			success: true,

			filename: filename,

			mimetype: data.mimetype,

			encoding: data.encoding,

			path: filepath

		};

	} catch (error) {

		console.log(error);
		return reply.code(500).send({ error: 'Failed to save file' });
	}
}


export const sendUploadForm = async (request: FastifyRequest, reply: FastifyReply) => {

	return reply.sendFile('views/uploadFile.html')
}
